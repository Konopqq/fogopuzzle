<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FOGO Christmas Puzzles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;500;700;800;900&family=Funnel+Display:wght@300;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-dark-blue: #0C1825;
            --color-orange: #FF3D00;
            --color-white: #FFFFFF;
            --color-gray: #F2F2F2;
            --color-ice: rgba(200, 230, 255, 0.15);
            --sidebar-width: 320px;
            --font-primary: 'Funnel Display', sans-serif;
            --font-secondary: 'DM Sans', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--color-dark-blue);
            color: var(--color-white);
            font-family: var(--font-secondary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            user-select: none;
        }

        @media (min-width: 1600px) {
            :root {
                --sidebar-width: 420px;
            }
            body { font-size: 18px; }
            .timer-display { font-size: 42px !important; }
            .btn-primary { font-size: 20px !important; padding: 18px !important; }
            .form-title { font-size: 16px !important; }
            .brand-logo { max-width: 180px !important; }
        }

        .garland-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 30px; z-index: 500;
            pointer-events: none; display: flex; justify-content: space-around; overflow: hidden;
        }
        .light {
            width: 12px; height: 12px; border-radius: 50%; background: #fff; margin-top: -5px;
            box-shadow: 0 5px 15px rgba(255,255,255,0.8); animation: glow 1.5s infinite alternate;
        }
        .light:nth-child(2n) { background: var(--color-orange); box-shadow: 0 5px 15px rgba(255, 61, 0, 0.8); animation-delay: 0.5s; }
        .light:nth-child(3n) { background: #00ff00; box-shadow: 0 5px 15px rgba(0, 255, 0, 0.8); animation-delay: 1s; }
        .light:nth-child(4n) { background: #ffd700; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.8); animation-delay: 0.2s; }
        @keyframes glow { from { opacity: 0.4; transform: scale(0.8); } to { opacity: 1; transform: scale(1.1); } }

        .sidebar {
            width: var(--sidebar-width);
            background: rgba(12, 24, 37, 0.95);
            border-right: 1px solid rgba(255,255,255,0.1);
            box-shadow: 5px 0 30px rgba(0,0,0,0.3), inset 0 0 20px var(--color-ice); 
            padding: 30px 25px;
            display: flex; flex-direction: column; gap: 20px;
            z-index: 200; flex-shrink: 0; overflow-y: auto; 
            backdrop-filter: blur(10px);
            transition: width 0.3s ease;
        }

        .brand-container {
            display: flex; justify-content: flex-start; align-items: center; margin-bottom: 5px; padding-left: 5px;
        }
        .brand-logo { max-width: 140px; height: auto; display: block; }

        .controls-wrapper { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }

        .form-title {
            font-family: var(--font-primary); font-size: 13px; color: var(--color-gray); opacity: 0.6;
            margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .avatar-wrapper { display: flex; justify-content: flex-start; }
        .avatar-upload {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            overflow: hidden; transition: all 0.3s ease; position: relative;
        }
        .avatar-upload:hover { border-color: var(--color-orange); background: rgba(255, 61, 0, 0.05); }
        .avatar-upload.error { border-color: var(--color-orange); animation: shake 0.4s; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-placeholder { text-align: center; color: var(--color-gray); opacity: 0.5; }
        .avatar-placeholder span { font-size: 24px; display: block; } 
        
        input[type="text"] {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; border-radius: 8px; color: var(--color-white); font-family: var(--font-secondary);
            font-size: 15px; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: var(--color-orange); background: rgba(255,255,255,0.08); }
        input[type="text"].error { border-color: var(--color-orange); animation: shake 0.4s; }

        .volume-control { margin-top: 5px; }
        .volume-slider {
            -webkit-appearance: none; width: 100%; height: 6px;
            background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--color-orange); cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 10px var(--color-orange);
        }
        .volume-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .timer-display {
            font-family: var(--font-primary); font-size: 32px; color: var(--color-orange); font-weight: 500;
            text-align: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05); letter-spacing: 2px; margin-top: auto;
            text-shadow: 0 0 10px rgba(255, 61, 0, 0.3);
        }

        .btn-primary {
            background: var(--color-orange); color: var(--color-white); border: none; padding: 14px;
            border-radius: 50px; font-family: var(--font-primary); font-size: 16px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.3); transition: 0.2s; position: relative; overflow: hidden;
        }
        .btn-primary::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        .btn-primary:hover { background: #FF5522; transform: translateY(-2px); }

        .btn-simple {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
            padding: 10px;
            border-radius: 8px;
            font-family: var(--font-primary);
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
            margin-top: 5px;
        }
        .btn-simple:hover {
            border-color: var(--color-white);
            color: var(--color-white);
            background: rgba(255,255,255,0.05);
        }

        .sidebar-hint-box {
            display: none; 
            margin-top: 15px;
            border: 3px solid var(--color-orange);
            border-radius: 12px;
            overflow: hidden;
            animation: fadeIn 0.3s;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .sidebar-hint-box img { width: 100%; display: block; }
        .sidebar-hint-box.visible { display: block; }

        #field-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            opacity: 0; pointer-events: none; z-index: 1; transition: opacity 0.3s; border-radius: 4px;
        }
        #field-hint.visible { opacity: 0.3; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #game-area {
            flex-grow: 1; position: relative;
            background: radial-gradient(circle at center, #132233 0%, var(--color-dark-blue) 100%);
            overflow: hidden; overscroll-behavior: none;
        }

        .bg-snow {
            position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8;
            pointer-events: none; z-index: 1; animation: slowFall linear infinite;
        }
        @keyframes slowFall { to { transform: translateY(110vh) rotate(360deg); } }

        #board-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 2px dashed rgba(255, 255, 255, 0.15); pointer-events: none; z-index: 0;
            border-radius: 4px; box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .puzzle-piece {
            position: absolute; filter: drop-shadow(2px 3px 4px rgba(0,0,0,0.5));
            touch-action: none; transition: transform 0.1s; will-change: left, top; z-index: 10;
        }
        .puzzle-piece.dragging {
            z-index: 9999 !important; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.7)); transform: scale(1.05);
        }

        @media (max-width: 850px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; max-height: 45vh; flex-direction: row; flex-wrap: wrap;
                padding: 15px; gap: 15px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            .brand-container { margin-bottom: 0; width: 100%; }
            .controls-wrapper { flex-direction: row; flex-wrap: wrap; width: 100%; gap: 10px; align-items: center; }
            .input-group { flex: 1; min-width: 120px; }
            .avatar-wrapper { display: flex; order: 1; } 
            .avatar-upload { width: 60px; height: 60px; }
            .avatar-placeholder span { font-size: 18px; }
            .avatar-placeholder small { font-size: 8px; }
            
            .input-group:nth-child(2) { order: 2; }
            .volume-control { width: 100%; order: 3; margin-top: 0; }
            .btn-simple { width: auto; order: 3; flex: 1; margin-top: 0; }
            
            .timer-display { margin-top: 0; font-size: 20px; padding: 5px 10px; min-width: 60px; order: 4; }
            .btn-primary { width: auto; flex-grow: 1; font-size: 14px; padding: 10px; order: 5; }
            
            .sidebar-hint-box { display: none !important; }
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        .shake-effect { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .snap-flash { animation: flash 0.3s ease-out; }
        @keyframes flash { 0% { filter: brightness(1.5); } 100% { filter: brightness(1); } }

        .snow-flake {
            position: fixed; top: -10px; background: white; border-radius: 50%; pointer-events: none; z-index: 99999;
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        @keyframes snowfall { to { transform: translateY(110vh); opacity: 0; } }

        #win-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(12, 24, 37, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000; opacity: 0; pointer-events: none; transition: 0.4s;
            backdrop-filter: blur(8px);
        }
        #win-modal.active { opacity: 1; pointer-events: all; }
        .win-card {
            background: #15202E; border: 1px solid rgba(255,255,255,0.2);
            padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 30px var(--color-ice);
            width: 90%; max-width: 350px; position: relative;
        }
        .win-card::before { content: '‚ùÑÔ∏è'; font-size: 40px; position: absolute; top: -20px; right: -10px; transform: rotate(20deg); }
        .win-card h2 { font-family: var(--font-primary); color: var(--color-orange); margin: 0 0 10px 0; font-size: 32px; }
        .win-card p { color: #ccc; margin-bottom: 25px; font-size: 16px; }

        #hiddenCanvas, #resultCanvas { display: none; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="garland-container">
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
    </div>

    <aside class="sidebar">
        <div class="brand-container">
            <img src="logo1.png" alt="Fogo Logo" class="brand-logo" onerror="this.style.display='none';">
        </div>
        
        <div class="controls-wrapper">
            <div class="input-group avatar-wrapper">
                <label for="avatar-input" class="avatar-upload" id="avatar-container">
                    <div class="avatar-placeholder" id="avatar-placeholder">
                        <span>‚ùÑÔ∏è</span>
                        <small>Photo</small>
                    </div>
                    <img id="avatar-preview" src="">
                </label>
                <input type="file" id="avatar-input" accept="image/*" onchange="loadAvatar(this)">
            </div>

            <div class="input-group">
                <div class="form-title">Nickname *</div>
                <input type="text" id="nickname" placeholder="Your Name" autocomplete="off">
            </div>

            <div class="input-group volume-control">
                <div class="form-title">Music Volume üéµ</div>
                <input type="range" id="vol-slider" class="volume-slider" min="0" max="100" value="5">
            </div>

            <button class="btn-simple" onclick="toggleHint()">Show Hint</button>

            <div id="sidebar-hint" class="sidebar-hint-box">
                <img src="puzzle.png" alt="Hint">
            </div>

            <div class="timer-display" id="timer">00:00</div>
            
            <button class="btn-primary" onclick="attemptStartGame()">Start Game</button>
        </div>
    </aside>

    <main id="game-area">
        <img id="field-hint" src="puzzle.png" alt="Hint Background">
        <div id="board-guide"></div>
    </main>

    <div id="win-modal">
        <div class="win-card">
            <h2>GREAT JOB!</h2>
            <p>Puzzle completed! üéÑ</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-primary" onclick="downloadResult()">Download Result</button>
                <button class="btn-primary" style="background:transparent; border:1px solid #444;" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <audio id="bg-music" loop autoplay>
        <source src="Happy New Year.mp3" type="audio/mpeg">
    </audio>

    <canvas id="hiddenCanvas"></canvas>
    <canvas id="resultCanvas"></canvas>

    <script>
        const IMAGE_SRC = 'puzzle.png';
        const COLS = 8;
        const ROWS = 6;
        
        let BASE_SIZE = 80; 
        let TAB = 18;       
        let SNAP_DIST = 20;

        let pieces = [];
        let groups = [];
        let shapes = [];
        let timerInterval;
        let seconds = 0;
        let isPlaying = false;
        let userAvatarImg = null;

        const bgMusic = document.getElementById('bg-music');
        const volSlider = document.getElementById('vol-slider');
        bgMusic.volume = 0.05; 
        volSlider.addEventListener('input', (e) => { bgMusic.volume = e.target.value / 100; });

        window.addEventListener('load', () => {
            bgMusic.play().catch(() => {
                const unlockAudio = () => {
                    bgMusic.play();
                    document.removeEventListener('click', unlockAudio);
                    document.removeEventListener('touchstart', unlockAudio);
                };
                document.body.addEventListener('click', unlockAudio);
                document.body.addEventListener('touchstart', unlockAudio);
            });
        });

        const gameArea = document.getElementById('game-area');
        const guide = document.getElementById('board-guide');
        const fieldHint = document.getElementById('field-hint');
        const sidebarHint = document.getElementById('sidebar-hint');
        const imgObj = new Image();
        imgObj.crossOrigin = "Anonymous"; 
        imgObj.src = IMAGE_SRC;

        let isHintVisible = false;
        function toggleHint() {
            isHintVisible = !isHintVisible;
            if (isHintVisible) {
                if (window.innerWidth > 850) {
                    sidebarHint.classList.add('visible');
                } else {
                    fieldHint.classList.add('visible');
                }
            } else {
                sidebarHint.classList.remove('visible');
                fieldHint.classList.remove('visible');
            }
        }

        function startBackgroundSnow() {
            const flakeCount = 20; 
            for(let i=0; i<flakeCount; i++) {
                setTimeout(createBgFlake, Math.random() * 5000);
            }
            setInterval(createBgFlake, 800);
        }

        function createBgFlake() {
            const flake = document.createElement('div');
            flake.classList.add('bg-snow');
            const size = Math.random() * 3 + 1;
            flake.style.width = size + 'px';
            flake.style.height = size + 'px';
            flake.style.left = Math.random() * 100 + 'vw';
            const duration = Math.random() * 10 + 10;
            flake.style.animationDuration = duration + 's';
            flake.style.opacity = Math.random() * 0.5 + 0.1;
            gameArea.appendChild(flake);
            setTimeout(() => { flake.remove(); }, duration * 1000);
        }
        startBackgroundSnow();

        function calculateSizes() {
            const screenW = window.innerWidth;
            
            if (screenW > 1600) {
                BASE_SIZE = 110; 
                TAB = 24;
                SNAP_DIST = 30;
            } else if (screenW < 800) {
                BASE_SIZE = Math.floor((screenW - 40) / COLS);
                if (BASE_SIZE > 50) BASE_SIZE = 50;
                TAB = BASE_SIZE * 0.22;
                SNAP_DIST = BASE_SIZE * 0.4;
            } else {
                BASE_SIZE = 80;
                TAB = 18;
                SNAP_DIST = 20;
            }
        }

        imgObj.onload = () => { calculateSizes(); updateGuide(); };
        imgObj.onerror = () => { console.error("Could not load puzzle.png"); };
        
        window.addEventListener('resize', () => {
            calculateSizes();
            updateGuide();
        });

        function updateGuide() {
            const w = (COLS * BASE_SIZE) + 'px';
            const h = (ROWS * BASE_SIZE) + 'px';
            guide.style.width = w;
            guide.style.height = h;
            fieldHint.style.width = w;
            fieldHint.style.height = h;
        }

        function loadAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('avatar-preview');
                    const placeholder = document.getElementById('avatar-placeholder');
                    const container = document.getElementById('avatar-container');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    container.classList.remove('error');
                    userAvatarImg = new Image();
                    userAvatarImg.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function attemptStartGame() {
            const nickInput = document.getElementById('nickname');
            const avatarContainer = document.getElementById('avatar-container');
            let isValid = true;
            
            if (!nickInput.value.trim()) {
                nickInput.classList.add('error');
                setTimeout(() => nickInput.classList.remove('error'), 500);
                isValid = false;
            }
            if (!userAvatarImg) {
                if (window.getComputedStyle(avatarContainer.parentElement).display !== 'none') {
                    avatarContainer.classList.add('error');
                    setTimeout(() => avatarContainer.classList.remove('error'), 500);
                } else {
                     alert("Please upload an avatar photo.");
                }
                isValid = false;
            }

            if (!isValid) return;
            if (!imgObj.complete || imgObj.naturalWidth === 0) {
                alert("Image 'puzzle.png' not loaded.");
                return;
            }

            bgMusic.play().catch(e => { console.log("Audio autoplay prevented."); });
            initGame();
        }

        function generateShapes() {
            shapes = [];
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    shapes.push({
                        top: (y === 0) ? 0 : -shapes[(y-1)*COLS + x].bottom,
                        right: (x === COLS-1) ? 0 : (Math.random() > 0.5 ? 1 : -1),
                        bottom: (y === ROWS-1) ? 0 : (Math.random() > 0.5 ? 1 : -1),
                        left: (x === 0) ? 0 : -shapes[y*COLS + (x-1)].right
                    });
                }
            }
        }

        function drawPath(ctx, w, h, tab, s) {
            ctx.beginPath();
            ctx.moveTo(0, 0);
            if (s.top !== 0) {
                ctx.lineTo(w * 0.35, 0);
                ctx.bezierCurveTo(w * 0.35, -tab * s.top * 0.6, w * 0.4, -tab * s.top, w * 0.5, -tab * s.top);
                ctx.bezierCurveTo(w * 0.6, -tab * s.top, w * 0.65, -tab * s.top * 0.6, w * 0.65, 0);
            }
            ctx.lineTo(w, 0);
            if (s.right !== 0) {
                ctx.lineTo(w, h * 0.35);
                ctx.bezierCurveTo(w + tab * s.right * 0.6, h * 0.35, w + tab * s.right, h * 0.4, w + tab * s.right, h * 0.5);
                ctx.bezierCurveTo(w + tab * s.right, h * 0.6, w + tab * s.right * 0.6, h * 0.65, w, h * 0.65);
            }
            ctx.lineTo(w, h);
            if (s.bottom !== 0) {
                ctx.lineTo(w * 0.65, h);
                ctx.bezierCurveTo(w * 0.65, h + tab * s.bottom * 0.6, w * 0.6, h + tab * s.bottom, w * 0.5, h + tab * s.bottom);
                ctx.bezierCurveTo(w * 0.4, h + tab * s.bottom, w * 0.35, h + tab * s.bottom * 0.6, w * 0.35, h);
            }
            ctx.lineTo(0, h);
            if (s.left !== 0) {
                ctx.lineTo(0, h * 0.65);
                ctx.bezierCurveTo(-tab * s.left * 0.6, h * 0.65, -tab * s.left, h * 0.6, -tab * s.left, h * 0.5);
                ctx.bezierCurveTo(-tab * s.left, h * 0.4, -tab * s.left * 0.6, h * 0.35, 0, h * 0.35);
            }
            ctx.closePath();
        }

        function initGame() {
            calculateSizes();
            updateGuide();
            closeModal();
            pieces.forEach(p => p.el.remove());
            pieces = [];
            groups = [];
            
            stopTimer();
            seconds = 0;
            document.getElementById('timer').innerText = "00:00";
            startTimer();
            isPlaying = true;

            generateShapes();

            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d');
            const fullW = BASE_SIZE + TAB * 3;
            const fullH = BASE_SIZE + TAB * 3;
            const offsetX = TAB * 1.5; 
            const offsetY = TAB * 1.5;

            canvas.width = fullW;
            canvas.height = fullH;

            const boardW = COLS * BASE_SIZE;
            const boardH = ROWS * BASE_SIZE;
            const scaleX = boardW / imgObj.width;
            const scaleY = boardH / imgObj.height;
            const areaRect = gameArea.getBoundingClientRect();

            for (let i = 0; i < shapes.length; i++) {
                const shape = shapes[i];
                const col = i % COLS;
                const row = Math.floor(i / COLS);

                ctx.clearRect(0, 0, fullW, fullH);
                ctx.save();
                ctx.translate(offsetX, offsetY);
                drawPath(ctx, BASE_SIZE, BASE_SIZE, TAB, shape);
                ctx.clip();
                
                const srcX = (col * BASE_SIZE) / scaleX;
                const srcY = (row * BASE_SIZE) / scaleY;
                ctx.drawImage(imgObj, -srcX * scaleX, -srcY * scaleY, imgObj.width * scaleX, imgObj.height * scaleY);
                
                ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1.5; ctx.stroke();
                ctx.strokeStyle = "rgba(0,0,0,0.4)"; ctx.lineWidth = 0.5; ctx.stroke();
                ctx.restore();

                const img = document.createElement('img');
                img.src = canvas.toDataURL();
                img.className = 'puzzle-piece';
                img.style.width = fullW + 'px';
                img.style.height = fullH + 'px';
                
                const safeW = areaRect.width || window.innerWidth;
                const safeH = areaRect.height || window.innerHeight;
                const randX = Math.random() * (safeW - fullW);
                const randY = Math.random() * (safeH - fullH);

                img.style.left = Math.max(0, randX) + 'px';
                img.style.top = Math.max(0, randY) + 'px';
                
                img.addEventListener('mousedown', handleMouseDown);
                img.addEventListener('touchstart', handleMouseDown, {passive: false});

                gameArea.appendChild(img);
                
                pieces.push({ 
                    id: i, el: img, row: row, col: col, 
                    x: parseFloat(img.style.left), y: parseFloat(img.style.top),
                    offsetX: offsetX, offsetY: offsetY
                });
                groups[i] = [i];
            }
        }

        let dragInfo = null;

        function handleMouseDown(e) {
            if(!isPlaying) return;
            e.preventDefault();
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;

            const el = e.target;
            const pid = pieces.findIndex(p => p.el === el);
            if (pid === -1) return;

            let currentGroup = null;
            for(let g of groups) if(g && g.includes(pid)) { currentGroup = g; break; }
            if(!currentGroup) currentGroup = [pid];

            currentGroup.forEach(id => { 
                pieces[id].el.classList.add('dragging'); 
                pieces[id].el.style.transition = 'none';
            });
            const pieceStarts = currentGroup.map(id => ({ id, x: pieces[id].x, y: pieces[id].y }));
            dragInfo = { groupIds: currentGroup, startX: clientX, startY: clientY, pieceStarts };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            document.addEventListener('touchmove', handleMouseMove, {passive: false});
            document.addEventListener('touchend', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!dragInfo) return;
            e.preventDefault();
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const dx = clientX - dragInfo.startX;
            const dy = clientY - dragInfo.startY;

            dragInfo.pieceStarts.forEach(item => {
                const p = pieces[item.id];
                p.x = item.x + dx;
                p.y = item.y + dy;
                p.el.style.left = p.x + 'px';
                p.el.style.top = p.y + 'px';
            });
        }

        function handleMouseUp(e) {
            if (!dragInfo) return;
            dragInfo.groupIds.forEach(id => {
                pieces[id].el.classList.remove('dragging');
                pieces[id].el.style.transition = 'transform 0.1s';
            });
            checkConnections(dragInfo.groupIds);
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            document.removeEventListener('touchmove', handleMouseMove);
            document.removeEventListener('touchend', handleMouseUp);
            dragInfo = null;
        }

        function checkConnections(movedGroupIds) {
            let snapped = false;
            for (let i = 0; i < movedGroupIds.length; i++) {
                const me = pieces[movedGroupIds[i]];
                for (let otherId = 0; otherId < pieces.length; otherId++) {
                    if (movedGroupIds.includes(otherId)) continue;
                    const other = pieces[otherId];
                    if (me.row === other.row && me.col + 1 === other.col) if (trySnap(me, other, -BASE_SIZE, 0)) { snapped = true; break; }
                    if (me.row === other.row && me.col - 1 === other.col) if (trySnap(me, other, BASE_SIZE, 0)) { snapped = true; break; }
                    if (me.col === other.col && me.row + 1 === other.row) if (trySnap(me, other, 0, -BASE_SIZE)) { snapped = true; break; }
                    if (me.col === other.col && me.row - 1 === other.row) if (trySnap(me, other, 0, BASE_SIZE)) { snapped = true; break; }
                }
                if(snapped) break;
            }
            if (snapped) {
                triggerShake();
                triggerSnowBurst();
                checkWin();
            }
        }

        function trySnap(me, other, offX, offY) {
            const targetX = other.x + offX;
            const targetY = other.y + offY;
            if (Math.hypot(me.x - targetX, me.y - targetY) < SNAP_DIST) {
                const sX = targetX - me.x;
                const sY = targetY - me.y;
                let myGroup, otherGroup, myIdx, otherIdx;
                groups.forEach((g, i) => { if(g.includes(me.id)) {myGroup=g; myIdx=i;} if(g.includes(other.id)) {otherGroup=g; otherIdx=i;} });

                myGroup.forEach(pid => {
                    const p = pieces[pid];
                    p.x += sX; p.y += sY;
                    p.el.style.left = p.x + 'px'; p.el.style.top = p.y + 'px';
                    p.el.classList.add('snap-flash');
                    setTimeout(() => p.el.classList.remove('snap-flash'), 300);
                });

                groups[otherIdx] = otherGroup.concat(myGroup);
                groups[myIdx] = null;
                groups = groups.filter(g => g !== null);
                return true;
            }
            return false;
        }

        function triggerShake() {
            if (navigator.vibrate) navigator.vibrate(50);
            document.body.classList.add('shake-effect');
            setTimeout(() => document.body.classList.remove('shake-effect'), 400);
        }

        function triggerSnowBurst() {
            const flakesCount = 40; 
            for (let i = 0; i < flakesCount; i++) {
                const flake = document.createElement('i');
                flake.classList.add('snow-flake');
                const size = Math.random() * 5 + 3 + 'px'; 
                flake.style.width = size;
                flake.style.height = size;
                flake.style.left = Math.random() * 100 + 'vw'; 
                flake.style.opacity = Math.random() * 0.6 + 0.4; 
                const duration = Math.random() * 1.5 + 1.5 + 's';
                flake.style.animation = `snowfall ${duration} linear forwards`;
                document.body.appendChild(flake);
                setTimeout(() => { flake.remove(); }, 3500);
            }
        }

        function checkWin() {
            const activeGroups = groups.filter(g => g && g.length > 0);
            if (activeGroups.length === 1 && activeGroups[0].length === pieces.length) {
                stopTimer();
                isPlaying = false;
                setTimeout(() => { document.getElementById('win-modal').classList.add('active'); }, 500);
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function closeModal() { document.getElementById('win-modal').classList.remove('active'); }

        function downloadResult() {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const nick = document.getElementById('nickname').value;
            const time = document.getElementById('timer').innerText;

            canvas.width = imgObj.width;
            canvas.height = imgObj.height;

            ctx.drawImage(imgObj, 0, 0);

            const bottomY = canvas.height * 0.82;
            let textX = 50; 

            if (userAvatarImg) {
                const avSize = 120;
                const avX = 50;
                const avY = bottomY - avSize;
                ctx.save();
                ctx.beginPath();
                ctx.arc(avX + avSize/2, avY + avSize/2, avSize/2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(userAvatarImg, avX, avY, avSize, avSize);
                ctx.restore();
                ctx.beginPath();
                ctx.arc(avX + avSize/2, avY + avSize/2, avSize/2, 0, Math.PI * 2);
                ctx.strokeStyle = "#FF3D00";
                ctx.lineWidth = 6;
                ctx.stroke();
                textX += avSize + 40;
            }

            ctx.textAlign = "left";
            ctx.textBaseline = "bottom";

            ctx.font = "900 64px 'DM Sans', sans-serif"; 
            ctx.fillStyle = "#0C1825";
            ctx.strokeStyle = "#0C1825"; ctx.lineWidth = 2; 
            ctx.strokeText(nick, textX, bottomY - 65);
            ctx.fillText(nick, textX, bottomY - 65);

            ctx.font = "800 50px 'Funnel Display', sans-serif"; 
            ctx.fillStyle = "#FF3D00";
            ctx.strokeStyle = "#FF3D00"; ctx.lineWidth = 2; 
            ctx.strokeText("TIME: " + time, textX, bottomY - 10);
            ctx.fillText("TIME: " + time, textX, bottomY - 10);

            const link = document.createElement('a');
            link.download = `FOGO_Puzzle_${nick}.png`;
            try {
                link.href = canvas.toDataURL();
                link.click();
            } catch (e) {
                alert("Security Error: Use a Local Server to download.");
            }
        }
    </script>
</body>
</html>